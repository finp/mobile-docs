// start {partialsdir}/attributes.adoc[]
:org-name: AeroGear

:product-name: Mobile Services

:release-number: 1.0.0
:xamarin-sdk-release-number: 2.0.1
:ios-sdk-release-number: 2.0.0
:android-sdk-release-number: 2.0.0

:service-name:

:mobile-client: Mobile App
:mobile-client-openshift: Mobile Client in your OpenShift project
:mobile-cli: Mobile CLI

// Metrics Service
:metrics-service: Mobile Metrics
:grafana-ui: Grafana
:prometheus-ui: Prometheus

// IDM Service
:keycloak-service: Identity Management
:keycloak-ui: Keycloak Admin UI
:keycloak-dashboard: Auth Dashboard
:idm-name: Keycloak

// Push Service

:unifiedpush-service: Push Notifications
:push-ui: Unified Push Admin UI
:push-notification: push notification

// Build Service
:mobile-ci-cd-service: Mobile CI/CD
:mobilecicd-ui: Jenkins UI

// Device Security
:device-security-service: Device Security

// Sync Service
:sync-service: Data Sync
:data-sync-version: 0.1.0

:SDK: AeroGear SDK
:ios-sdk: AeroGear SDK for iOS
:android-sdk: AeroGear SDK for Android
:js-sdk: AeroGear SDK for Cordova
:xamarin-sdk: AeroGear SDK for Xamarin

:mobile-developer-console: Mobile Developer Console
// end {partialsdir}/attributes.adoc[]

:toc:

[[idm-service-intro]]
= Introduction to the IDM Service
:leveloffset: +1

// Module included in the following assemblies:
//
// <List assemblies here, each on a new line>

// Base the file name and the ID on the module title. For example:
// * file name: my-concept-module-a.adoc
// * ID: [id='my-concept-module-a']
// * Title: = My concept module A

// The ID is used as an anchor for linking to the module. Avoid changing it after the module has been published to ensure existing links are not broken.
:context: overview-of-the-service
[id='concept-explanation-{context}']
// The `context` attribute enables module reuse. Every module's ID includes {context}, which ensures that the module has a unique ID even if it is reused multiple times in a guide.
= Overview of the {keycloak-service} service
//In the title of concept modules, include nouns or noun phrases that are used in the body text. This helps readers and search engines find the information quickly.
//Do not start the title of concept modules with a verb. See also _Wording of headings_ in _The IBM Style Guide_.

The {keycloak-service} service allows you to add authentication and authorization to your mobile app.

* Secure your mobile app using the industry standard OpenID Connect protocol
* Add access control to your app based on user’s group membership
* Easily implement SSO, multi-factor authentication and Social Login support
* Back-end support for identity brokering and user federation

.Additional resources

* For more information about OpenID, see the link:https://openid.net/[OpenID Foundation, window="_blank"] website.
* See the link:https://www.keycloak.org/documentation.html[Keycloak documentation, window="_blank"] for more info.

:leveloffset: 1
:leveloffset: +1

// Module included in the following assemblies:
//
// <List assemblies here, each on a new line>

// Base the file name and the ID on the module title. For example:
// * file name: my-reference-a.adoc
// * ID: [id='my-reference-a']
// * Title: = My reference A

// The ID is used as an anchor for linking to the module. Avoid changing it after the module has been published to ensure existing links are not broken.
:context: identity-management-terminology
[id='reference-material-{context}']
// The `context` attribute enables module reuse. Every module's ID includes {context}, which ensures that the module has a unique ID even if it is reused multiple times in a guide.
= Identity Management Terminology
//In the title of a reference module, include nouns that are used in the body text. For example, "Keyboard shortcuts for ___" or "Command options for ___." This helps readers and search engines find the information quickly.

This section describes terminology that is associated with Identity Management.

.Identity Management Terminology
SSO:: Single Sign On, the ability to share a login between multiple services

OpenID Connect:: A standard for providing identity on top of OAuth 2.0

Keycloak:: Red Hat’s implementation of SSO and OpenID used as the identity provider

Client ID:: Is the client identifier for OpenID Connect requests, a simple alpha-numeric string

User Attributes:: Additional properties for user accounts (besides name and email) managed by Keycloak

:leveloffset: 1

[[getting-started-with-the-idm-service]]
= Getting Started with the IDM Service
:leveloffset: +1

// Module included in the following assemblies:
//
// <List assemblies here, each on a new line>

// Base the file name and the ID on the module title. For example:
// * file name: my-concept-module-a.adoc
// * ID: [id='my-concept-module-a']
// * Title: = My concept module A

// The ID is used as an anchor for linking to the module. Avoid changing it after the module has been published to ensure existing links are not broken.
:context: getting-started-with-idm
[id='concept-explanation-{context}']
// The `context` attribute enables module reuse. Every module's ID includes {context}, which ensures that the module has a unique ID even if it is reused multiple times in a guide.
= Getting Started with IDM
//In the title of concept modules, include nouns or noun phrases that are used in the body text. This helps readers and search engines find the information quickly.
//Do not start the title of concept modules with a verb. See also _Wording of headings_ in _The IBM Style Guide_.

Before getting started with the IDM Service, you must ensure that you have completed a number of prerequisites. Ensure that:

* [x] You are running OpenShift with {product-name} as described in xref:getting-started.adoc[Setting up AeroGear {product-name} on OpenShift].
* [x] You have provisioned Mobile Developer Console as described in xref:getting-started.adoc[Provisioning Mobile Developer Console].

.Additional resources

* A bulleted list of links to other material closely related to the contents of the concept module.

:leveloffset: 1
:leveloffset: +1

// Module included in the following assemblies:
//
// <List assemblies here, each on a new line>

// Base the file name and the ID on the module title. For example:
// * file name: doing-procedure-a.adoc
// * ID: [id='doing-procedure-a']
// * Title: = Doing procedure A

// The ID is used as an anchor for linking to the module. Avoid changing it after the module has been published to ensure existing links are not broken.
:context: setting-up-idm
[id='doing-one-procedure-{context}']
// The `context` attribute enables module reuse. Every module's ID includes {context}, which ensures that the module has a unique ID even if it is reused multiple times in a guide.
= Setting Up IDM
// Start the title of a procedure module with a verb, such as Creating or Create. See also _Wording of headings_ in _The IBM Style Guide_.

This section describes how to set up the IDM Mobile Service.

.Prerequisites

* xref:concept-explanation-getting-started-with-idm[Getting Started with IDM].

= Provisioning the {keycloak-service} Service

. Log into the OpenShift console.
. Create a new project or choose an existing project.
. Click *Add to Project* and choose *Browse Catalog* from the options.
+
You can filter the catalog items to only show mobile specific items by clicking the *Mobile* tab.
. Click *Services* and choose the {service-name} service.
+
image::catalog-mobile-services.png[]

. Follow the wizard for provisioning that service.
+
NOTE: If prompted to *Create a Binding*, choose *Do not bind at this time*
+
When provisioning an {keycloak-service} service, you are prompted to set the following configuration:
+
* *Keycloak admin username*: Username for Keycloak administration
+
* *Keycloak admin password*: Password for the Keycloak admin user
+
* *Name of the Keycloak realm*: Name of the keycloak realm. (defaults to current namespace)
+
NOTE: A realm manages a set of users, credentials, roles, and groups. A user belongs to and logs into a realm. Realms are isolated from one another and can only manage and authenticate the users that they control.
+
* *Connect to an existing shared service*: Select if you want to use an existing service and you have the URL and credentials to use that service.
+
* *URL of the shared service*: Enter a value if you want to use an existing shared service.

Once the wizard steps are completed, navigate to the Project Overview in OpenShift to see the newly provisioned service.
Provisioning a service may take some time.

.Additional resources

* A bulleted list of links to other material closely related to the contents of the concept module.

:leveloffset: 1
:leveloffset: +1

// Module included in the following assemblies:
//
// <List assemblies here, each on a new line>

// Base the file name and the ID on the module title. For example:
// * file name: doing-procedure-a.adoc
// * ID: [id='doing-procedure-a']
// * Title: = Doing procedure A

// The ID is used as an anchor for linking to the module. Avoid changing it after the module has been published to ensure existing links are not broken.
:context: binding-an-app-to-a-service
[id='doing-one-procedure-{context}']
// The `context` attribute enables module reuse. Every module's ID includes {context}, which ensures that the module has a unique ID even if it is reused multiple times in a guide.
= Binding a {mobile-client} with the IDM Service

To use mobile services, you must represent your mobile app in *Mobile Developer Console*, and that app must be associated with the mobile service.
This association is called *binding* and it is necessary for your mobile app to use that service.

This section describes how to set up the IDM Mobile Service.

.Prerequisites

* xref:concept-explanation-getting-started-with-idm[Getting Started with IDM].

= Procedure

To bind a {mobile-client} with a mobile service:

. Launch {mobile-developer-console}

. Click on the {mobile-client} on the Overview screen

. Navigate to *Mobile Services* tab.
+
image::mobile-clients-services-all-unbound.png[]

+
NOTE: It is possible to bind a {mobile-client} with a mobile service in the OpenShift console, however such bindings are not valid for the purposes of this procedure.

. Press *Bind to App* in the {service-name}
. Fill out the binding parameters required by the {service-name} Service.

+
image::mobile-clients-services-idm-parameters.png[]
NOTE: Use `Public` when binding a {mobile-client} to a {service-name}. When binding mobile services to each other, use `Bearer`.

The {service-name} service will now be expandable, details about the service can be viewed.

image::mobile-clients-services-all-idm-provisioned.png[]

.Additional resources

* A bulleted list of links to other material closely related to the contents of the concept module.

:leveloffset: 1
:leveloffset: +1

// Module included in the following assemblies:
//
// <List assemblies here, each on a new line>

// Base the file name and the ID on the module title. For example:
// * file name: doing-procedure-a.adoc
// * ID: [id='doing-procedure-a']
// * Title: = Doing procedure A

// The ID is used as an anchor for linking to the module. Avoid changing it after the module has been published to ensure existing links are not broken.
:context: configuring-the-service
[id='doing-one-procedure-{context}']
// The `context` attribute enables module reuse. Every module's ID includes {context}, which ensures that the module has a unique ID even if it is reused multiple times in a guide.
= Configuring the Service

This section guides you through configuring the schema of the redirect url and web origin for a client in {idm-name}.
This is required to enable OpenID authentication.
For an explanation of these terms, see link:https://www.keycloak.org/documentation.html[Keycloak Documentation].

.Prerequisites

* xref:concept-explanation-getting-started-with-idm[Getting Started with IDM].

= Procedure

. Choose the schema of a redirect url
+
[tabs]
====
Cordova::
+
--
Redirect url is `\http://localhost/\*`, without `:/callback`. Web Origin is `\http://localhost/*`.
--
====
+
. Log into the OpenShift console and navigate to the Project Overview.

. Navigate to the {mobile-client} screen.

. Select the Mobile Services tab.

. If a binding to the {keycloak-service} service is in progress, a spinning icon is displayed to the right of the {keycloak-service} entry. Wait for the binding process to complete.

. If the _Keycloak Realm URL_ URL is not visible, expand the Identity Management Service by clicking the > icon.

. Click on the *Keycloak Realm URL* link to open the Keycloak Administration Console.

. Log in to the Administration console using the credentials you specified when xref:#provisioning[Provisioning] the service (defaults to admin:admin).

. Select `Clients` from the left navigation menu.

. Select your client from the list of clients. The name of your client is derived from the name of the {mobile-client}, the name of the mobile development platform and the client type, for example `myapp-android-public`.

. Add `<schema>:/callback` as an additional entry to `Valid Redirect URIs`. See xref:choose-schema[] to determine the value for `<schema>`.

. Add `<schema>` as an additional entry to `Web Origins`.  See xref:choose-schema[] to determine the value for `<schema>`.

. Save your changes.

. Create a new user account as described in link:https://www.keycloak.org/docs/3.3/server_admin/topics/users/create-user.html[Creating a New User].

. Set up credentials for the new user as described in link:https://www.keycloak.org/docs/3.3/server_admin/topics/users/credentials.html[User Credentials].

.Additional resources

* A bulleted list of links to other material closely related to the contents of the concept module.

:leveloffset: 1
:leveloffset: +1

// Module included in the following assemblies:
//
// <List assemblies here, each on a new line>

// Base the file name and the ID on the module title. For example:
// * file name: doing-procedure-a.adoc
// * ID: [id='doing-procedure-a']
// * Title: = Doing procedure A

// The ID is used as an anchor for linking to the module. Avoid changing it after the module has been published to ensure existing links are not broken.
:context: downloading-configuration-file
[id='doing-one-procedure-{context}']
// The `context` attribute enables module reuse. Every module's ID includes {context}, which ensures that the module has a unique ID even if it is reused multiple times in a guide.
= Downloading the Configuration File

This section describes how to download the configuration file.

.Prerequisites

* xref:concept-explanation-getting-started-with-idm[Getting Started with IDM].

= Procedure

. Open your {mobile-client} in Mobile Developer Console.
. Copy the `mobile-services.json` configuration to your clipboard.
. Save the contents of the clipboard to a new file called `mobile-services.json`.
+
NOTE: The mobile-services.json file is the link between your provisioned services on OpenShift and the mobile app you are developing. This file provides all required configuration to initialise the various SDKs and get them hooked up/connected to the back-end services.
. Follow the platform-specific instructions:

[role="primary"]
.Android
****
Move mobile-services.json to the following location in your application project:

`app/src/main/assets/mobile-services.json`
****

[role="secondary"]
.iOS
****
Move mobile-services.json to the following location in your application project:

`<app directory>/mobile-services.json`

NOTE: Ensure that `mobile-services.json` is a member of the project in the Xcode Project Navigator.
****

[role="secondary"]
.Cordova
****
Move mobile-services.json to the following location in your application project:

`src/mobile-services.json`
****

[role="secondary"]
.Xamarin
****

Move mobile-services.json to the following location in your application project:

`Resources/mobile-services.json`
****

.Additional resources

* A bulleted list of links to other material closely related to the contents of the concept module.

:leveloffset: 1
:leveloffset: +1

// Module included in the following assemblies:
//
// <List assemblies here, each on a new line>

// Base the file name and the ID on the module title. For example:
// * file name: doing-procedure-a.adoc
// * ID: [id='doing-procedure-a']
// * Title: = Doing procedure A

// The ID is used as an anchor for linking to the module. Avoid changing it after the module has been published to ensure existing links are not broken.
:context: setting-up-the-idm-sdk
[id='doing-one-procedure-{context}']
// The `context` attribute enables module reuse. Every module's ID includes {context}, which ensures that the module has a unique ID even if it is reused multiple times in a guide.
= Setting up the IDM sdk

This section helps you to set up the {keycloak-service} service SDK in your App.
It describes how to set up and initialize the IDM sdk.

.Prerequisites

* xref:concept-explanation-getting-started-with-idm[Getting Started with IDM].

= Procedure

1. Import the libraries

[role="primary"]
.Android
****
. Add the following dependency in your app's *build.gradle*:
+
[source,groovy,subs="attributes"]
----
dependencies {
    implementation "org.aerogear:android-auth:{release-number}"
}
----
. To prevent build errors, add the following in your app's *build.gradle*:
[source,groovy,subs="attributes"]
+
----
compileOptions {
    sourceCompatibility 1.8
    targetCompatibility 1.8
}
----
****

[role="secondary"]
.iOS
****
. Add the dependency to your *Podfile*:
+
[source,ruby,subs="attributes"]
----
target '[TARGET NAME]' do
    pod 'AGSAuth', '{release-number}'
end
----

. Update the dependencies:
+
[source,bash]
----
$ pod install
----

. Import and instantiate `AGSAuth` to start using the SDK:
+
[source,swift]
----
import AGSAuth

auth = AGSAuth()
----
****

[role="secondary"]
.Cordova
****
Install the link:https://www.npmjs.com/package/@aerogear/auth[AeroGear Auth] package from link:https://www.npmjs.com/[NPM, window="_blank"]:
[source,bash]
----
$ npm install @aerogear/auth
----
****

[role="secondary"]
.Xamarin
****
. Install link:https://docs.microsoft.com/en-us/nuget/install-nuget-client-tools[NuGet, window="_blank"].

. Install the link:https://www.nuget.org/packages/AeroGear.Mobile.Core[AeroGear Core, window="_blank"] package:
+
[source,bash,subs="attributes"]
----
dotnet add package AeroGear.Mobile.Core --version {release-number}
----

. For Android run:
+
[source,bash,subs="attributes"]
----
dotnet add package AeroGear.Mobile.Core.Platform.Android --version {release-number}
dotnet add package AeroGear.Mobile.Auth.Platform.Android --version {release-number}
----

. For iOS run:
+
[source,bash,subs="attributes"]
----
dotnet add package AeroGear.Mobile.Core.Platform.iOS --version {release-number}
dotnet add package AeroGear.Mobile.Auth.Platform.iOS --version {release-number}
----
****

2. Initialize the SDK

[role="primary"]
.Android
****

. Specify the redirect URL. It is recommended to use the package name of your app.
+
----
AuthServiceConfiguration authServiceConfig = new AuthServiceConfiguration
    .AuthConfigurationBuilder()
    .withRedirectUri("org.aerogear.mobile.example:/callback")
    .build();
----

. Create the auth service:
+
[source,java]
----
AuthService authService = new AuthService(authServiceConfig);
----
****

[role="secondary"]
.iOS
****
Set your custom configuration to the auth service instance, making sure the redirect URL matches the App's Bundle Id.

[source,swift]
----
// create the authentication config
let authenticationConfig = AuthenticationConfig(redirectURL: "org.aerogear.mobile.example:/callback")
try! AgsAuth.instance.configure(authConfig: authenticationConfig, useExternalUserAgent: false)
----
****

[role="secondary"]
.Cordova
****

Import and initialize Auth:

[source,javascript]
----
const Auth = require('@aerogear/auth').Auth;

const authService = new Auth();
const initOptions = { onLoad: "login-required" };

authService.init(initOptions)
    .then(() => {
        // successful init & authentication
    })
    .catch((err) => {
        // initialization error
    });
----

You can pass `login-required` or `check-sso` to the init function. `login-required` will authenticate the client if the user is logged in to Keycloak or display the login page if not. `check-sso` will only authenticate the client if the user is already logged in. If the user is not logged in the browser will be redirected back to the application and remain unauthenticated. By default, the `check-sso` option is used.

NOTE: Initialization will also perform authentication

****

[role="secondary"]
.Xamarin
****

. Create an link:https://developer.android.com/guide/topics/manifest/manifest-intro#ifs[intent filter, window="_blank"] for the `net.openid.appauth.RedirectUriReceiverActivity` activity. This step is required for Xamarin Android and allows the login browser to redirect back to your App. Add this to your `AndroidManifest.xml`:
+
[source,xml]
----
<activity android:name="net.openid.appauth.RedirectUriReceiverActivity" android:exported="true"  android:icon="@mipmap/ic_launcher" android:roundIcon="@mipmap/ic_launcher_round">
    <intent-filter>
        <action android:name="android.intent.action.VIEW" />
        <category android:name="android.intent.category.DEFAULT" />
        <category android:name="android.intent.category.BROWSABLE" />
        <data android:scheme="org.aerogear.mobile.example" />
    </intent-filter>
</activity>
----

. Initialize the Auth module
.. For an Android app (MainActivity.cs):
+
[source,csharp]
----
var app = new App();
MobileCoreAndroid.Init(app.GetType().Assembly,ApplicationContext);
var authService = AuthService.InitializeService();
var authConfig = AuthenticationConfig.Builder.RedirectUri("org.aerogear.mobile.example:/callback").Build();
authService.Configure(authConfig);
----
+
NOTE: For Android an link:https://developer.android.com/guide/topics/manifest/manifest-intro#ifs[Intent filter, window="_blank"] should be configured with the callback URL specified in AuthenticateOptions in the App's AndroidManifest.xml. See the link:https://github.com/aerogear/xamarin-showcase-template/blob/master/Example.Android/Properties/AndroidManifest.xml[example app, window="_blank"].

.. For an iOS app (FinishedLaunching method of AppDelegate.cs):
+
[source,swift]
----
var app = new App();
MobileCore core = MobileCoreIOS.Init(app.GetType().Assembly);
var authService = AuthService.InitializeService();
var authConfig = AuthenticationConfig.Builder.RedirectUri("org.aerogear.mobile.example:/callback").Build();
authService.Configure(authConfig);
----

. To use self-signed certificates with Xamarin Android:
.. Create a file at `Resources/xml/network_security_config.xml` with the following code:
+
[source,xml]
----
<network-security-config>
  <base-config>
    <trust-anchors>
      <certificates src="user"/>
      <certificates src="system"/>
    </trust-anchors>
  </base-config>
</network-security-config>
----
.. Add the following value to the `<application>` tag in `AndroidManifest.xml`:
+
[source,xml]
----
android:networkSecurityConfig="@xml/network_security_config"
----
****

.Additional resources

* A bulleted list of links to other material closely related to the contents of the concept module.

:leveloffset: 1
